# Data Models

This document defines the data schemas for the different data stores used in the RAG Chatbot feature.

## 1. Qdrant - Vector Database

### `ContentChunk` Collection

This collection stores the vectorized content of the book.

-   **Vectors**: Stored using Cohere's embedding model (`embed-english-v3.0`).
-   **Payload (Metadata)**: Each vector is associated with a payload containing the following fields, as defined in the specification.

| Field | Data Type | Description |
| :--- | :--- | :--- |
| `raw_text` | `string` | The raw text content of the chunk. |
| `chapter_number` | `integer` | The number of the chapter the chunk belongs to. |
| `chapter_title` | `string` | The title of the chapter. |
| `section_number`| `integer` | The number of the section within the chapter. |
| `section_title` | `string` | The title of the section. |
| `page_number` | `integer` | (Optional) The page number where the chunk can be found. |

## 2. Neon (Postgres) - Relational Database

This database stores chat session and message history for traceability and auditing purposes, fulfilling requirement FR-009.

### `chat_sessions` table

Represents a single conversation session with a user.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | Primary Key, Default: `gen_random_uuid()` | Unique identifier for the session. |
| `created_at` | `TIMESTAMPTZ` | NOT NULL, Default: `NOW()` | Timestamp when the session was created. |
| `user_id` | `VARCHAR(255)`| | (Optional) Identifier for the user if they are logged in. |

### `chat_messages` table

Represents a single message within a chat session, including the query and the response, along with the data needed for full traceability.

| Column | Data Type | Constraints | Description |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | Primary Key, Default: `gen_random_uuid()` | Unique identifier for the message. |
| `session_id` | `UUID` | Foreign Key to `chat_sessions.id` | The session this message belongs to. |
| `interaction_mode`| `VARCHAR(20)` | NOT NULL | The mode of interaction ('book-wide' or 'selection-only'). |
| `user_query` | `TEXT` | NOT NULL | The original question asked by the user. |
| `retrieved_context`| `JSONB` | | The retrieved text chunks, including their metadata and scores. `NULL` for selection-only mode. |
| `llm_prompt` | `TEXT` | NOT NULL | The exact and complete prompt sent to the Cohere API. |
| `final_response` | `TEXT` | NOT NULL | The final response generated by the LLM and sent to the user. |
| `is_refusal` | `BOOLEAN` | NOT NULL, Default: `false` | `true` if the system refused to answer the query. |
| `created_at` | `TIMESTAMPTZ` | NOT NULL, Default: `NOW()` | Timestamp when the message was recorded. |
